{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center animate-fade">
    <div class="col-md-7">
        <div class="card p-4 p-lg-5 glass-card border-0">
            <div class="d-flex align-items-center mb-5">
                <div class="bg-primary-subtle rounded-4 p-3 me-3">
                    <i class="bi bi-shield-plus text-primary fs-2"></i>
                </div>
                <div>
                    <h2 class="h3 mb-1">Secure New Platform</h2>
                    <p class="text-muted mb-0">Adding a layer of visual protection to your accounts.</p>
                </div>
            </div>

            <form method="POST" enctype="multipart/form-data">
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Platform Name</label>
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-end-0 text-muted"><i
                                    class="bi bi-globe"></i></span>
                            <input type="text" name="platform_name" class="form-control border-start-0"
                                placeholder="e.g. Gmail, Netflix" required>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">Platform Category</label>
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-end-0 text-muted"><i
                                    class="bi bi-tags"></i></span>
                            <select name="category" class="form-select border-start-0" required>
                                <option value="other">General / Other</option>
                                <option value="people">People / Faces</option>
                                <option value="pets">Pets / Animals</option>
                                <option value="nature">Nature / Landscapes</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-bold">Platform Password</label>
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-end-0 text-muted"><i
                                    class="bi bi-key-fill"></i></span>
                            <input type="text" name="password" id="generated-password"
                                class="form-control border-start-0 font-monospace" value="{{ generated_pass }}">
                            <button class="btn btn-outline-primary" type="button" onclick="regeneratePassword()"
                                title="Regenerate">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyPassword()"
                                title="Copy">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                        <div class="form-text mt-2">Adjust the password or use the generated one.</div>
                    </div>

                    <div class="col-12">
                        <div class="p-4 border border-dashed rounded-4 bg-light text-center">
                            <label class="form-label fw-bold d-block mb-3">Upload Secret Security Image</label>
                            <div class="mb-3">
                                <i class="bi bi-image-fill display-4 text-primary-subtle"></i>
                            </div>
                            <input type="file" name="secret_image" class="form-control" id="imageInput" accept="image/*"
                                required onchange="previewImage(event)">
                            <div class="form-text mt-3">This image will be your visual key to reveal this password.
                            </div>
                            <img id="image-preview" class="mt-3 rounded-3 shadow-sm d-none"
                                style="max-height: 200px; max-width: 100%;">
                        </div>
                    </div>

                    <div class="col-12 mt-5">
                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-primary flex-grow-1 py-3 rounded-pill text-uppercase">
                                <i class="bi bi-check-circle-fill me-2"></i> Save to Vault
                            </button>
                            <a href="{{ url_for('dashboard') }}"
                                class="btn btn-light px-4 py-3 rounded-pill bg-white">Cancel</a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function regeneratePassword() {
        const btn = event.currentTarget;
        btn.classList.add('bi-spin');
        fetch('/api/generate-password')
            .then(response => response.json())
            .then(data => {
                document.getElementById('generated-password').value = data.password;
                setTimeout(() => btn.classList.remove('bi-spin'), 600);
            });
    }

    function copyPassword() {
        const passInput = document.getElementById('generated-password');
        passInput.select();
        document.execCommand('copy');
        // SweetAlert approach for better UI if we had it, but standard alert for now
        alert('Password copied to clipboard!');
    }

    function previewImage(event) {
        const reader = new FileReader();
        reader.onload = function () {
            const output = document.getElementById('image-preview');
            output.src = reader.result;
            output.classList.remove('d-none');
        };
        reader.readAsDataURL(event.target.files[0]);
    }
</script>
<style>
    .bi-spin i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        100% {
            transform: rotate(360deg);
        }
    }

    .border-dashed {
        border: 2px dashed #cbd5e1 !important;
    }
</style>
{% endblock %}